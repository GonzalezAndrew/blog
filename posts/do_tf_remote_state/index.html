<!doctype html><html lang=en><head><meta name=generator content="Hugo 0.83.1"><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="IE=edge"><meta property="og:title" content="DigitalOcean Terraform Remote State"><meta name=author content="Andrew Gonzalez"><meta name=keywords content="terraform,digitalocean,tutorial"><meta name=description content="Remote State for Terraform in DigialOcean"><meta property="og:title" content="DigitalOcean Terraform Remote State"><meta property="og:description" content="Remote State for Terraform in DigialOcean"><meta property="og:type" content="article"><meta property="og:url" content="http://gonzalezandrew.com/posts/do_tf_remote_state/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-06-05T00:03:31-05:00"><meta property="article:modified_time" content="2021-06-05T00:03:31-05:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="DigitalOcean Terraform Remote State"><meta name=twitter:description content="Remote State for Terraform in DigialOcean"><link rel=stylesheet type=text/css media=screen href=/css/normalize.css><link rel=stylesheet type=text/css media=screen href=/css/main.css><link rel=stylesheet type=text/css media=screen href=/css/all.css><link rel=stylesheet href=/css/katex.min.css crossorigin=anonymous><script defer src=/js/katex.min.js integrity=sha384-y23I5Q6l+B6vatafAwxRu/0oK/79VlbSz7Q9aiSZUvyWYIYsd+qj+o24G5ZU2zJz crossorigin=anonymous></script><script defer src=/js/auto-render.min.js integrity=sha384-kWPLUVMOks5AQFrykwIup5lo0m3iMkkHrD0uJ4H5cjeGihAutqP0yW0J6dpFiVkI crossorigin=anonymous onload=renderMathInElement(document.body)></script><script>document.addEventListener("DOMContentLoaded",function(){renderMathInElement(document.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1}]})})</script><link rel=stylesheet type=text/css media=screen href=/css/syntax.css><title>DigitalOcean Terraform Remote State | Andrew Gonzalez</title></head><body><header><div id=avatar><a href=http://gonzalezandrew.com/><img src=/images/me.jpg alt="Andrew Gonzalez"></a></div><div id=titletext><h2 id=title><a href=http://gonzalezandrew.com/>Andrew Gonzalez</a></h2></div><div id=title-description><p id=subtitle>DevOps Engineer who has his head stuck in the clouds.</p><div id=social><nav><ul><li><a href=https://github.com/GonzalezAndrew><i title=Github class="icons fab fa-github"></i></a></li><li><a href=https://twitter.com/_GonzalezAndrew><i title=Twitter class="icons fab fa-twitter-square"></i></a></li><li><a href=https://www.linkedin.com/in/-andrew-gonzalez/><i title=LinkedIn class="icons fab fa-linkedin"></i></a></li></ul></nav></div></div><div id=mainmenu><nav><ul><li><a href=/>Home</a></li><li><a href=/posts>Blog</a></li><li><a href=/about>About</a></li><li><a href=/tags>Tags</a></li></ul></nav></div></header><main><div class=post><div class=author></div><div class=post-header><div class=meta><div class=date><span class=day>05</span>
<span class=rest>Jun 2021</span></div></div><div class=matter><h1 class=title>DigitalOcean Terraform Remote State</h1></div></div><div class=markdown><p>Recently I began to get interested in using <a href=https://www.digitalocean.com/ target=_blank>DigitalOcean</a>
has my personal playground. Granted DigitalOcean is not widely adopted but the small cloud provider has so much to offer at a resonable price compared to other providers such as AWS. Naturally, if I&rsquo;m going to be deploying infrastructure, applications, etc to a cloud provider, I want to use Terraform.</p><p>Terraform provides a simple but powerful way to invoke Cloud Provider APIs which allow you to provison infrastructure easily. Another great advantage of Terraform which I love, is the ability to know the state of the resources you deploy using Terraform. By knowing the state of your resources you have in your environment help leads away from configuration drift which other tools can suffer from when provisioning infrastructure such as Ansible. Another advantage of having the state with Terraform is the ability to use the state to inject data into other Terraform modules/scripts you might be working on. An example would be if you are deploying an EC2 instances to your AWS environment and you want to deploy said instance in a particular subnet that you deployed using Terraform. You could use Terraform remote state data block to import the subnet id the instance needs and would look something like so:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-hcl data-lang=hcl><span class=k>data</span> <span class=s2>&#34;terraform_remote_state&#34; &#34;vpc&#34;</span> {
<span class=n>  backend</span> <span class=o>=</span> <span class=s2>&#34;remote&#34;</span>

<span class=n>  config</span> <span class=o>=</span> {
<span class=n>    organization</span> <span class=o>=</span> <span class=s2>&#34;hashicorp&#34;</span>
<span class=n>    workspaces</span> <span class=o>=</span> {
<span class=n>      name</span> <span class=o>=</span> <span class=s2>&#34;vpc-prod&#34;</span>
    }
  }
}

<span class=k>resource</span> <span class=s2>&#34;aws_instance&#34; &#34;foo&#34;</span> {
<span class=n>  subnet_id</span> <span class=o>=</span> <span class=k>data</span><span class=p>.</span><span class=k>terraform_remote_state</span><span class=p>.</span><span class=k>vpc</span><span class=p>.</span><span class=k>outputs</span><span class=p>.</span><span class=k>subnet_id</span>
}
</code></pre></td></tr></table></div></div><p>Thankfully, DigitalOcaen has a storage resouces called, <a href=https://www.digitalocean.com/products/spaces/ target=_blank>Spaces</a>
, which work very similiarly to AWS S3 buckets. DigitalOcean developed the Spaces API to be able to work alongside the AWS S3 API, meaning you can use the <code>aws cil</code>, <code>aws s3api</code>, and other various tools which take advantage of the AWS S3 API to manipulate your DigitalOcean Spaces resources. This is fantastic! Since I already use AWS daily for work, moving to use DigitalOcean Spaces should be quite easy. This also means we can store all of our Terraform state files in a DigitalOcean Space and use the <code>terraform_remote_state</code> <code>s3</code> data block to pull any attributes from those saved statefiles.</p><h2 id=before-deploying-the-space>Before Deploying the Space</h2><p>If you want to follow along with this post, you&rsquo;ll first need a DigitalOcean account. Once you have created your DigitalOcean account, you&rsquo;ll need to create a DigialOcean API personal token and Space Access Keys. When creating your keys, try to choose a meaningful name for your keys so you know what or who might be using them. I used <code>terraform</code>, when creating my keys so next time I check the keys I know the purpose for the keys. Also, try to store your keys in a secure location which means please don&rsquo;t use a text file! If you&rsquo;re cheap like me, you could use <a href=https://bitwarden.com/ target=_blank>Bitwarden</a>
for you secrets vault. Bitwarden is super simple to use, can store all your SSH keys, logins, API Tokens, etc. Did I also mention it&rsquo;s free and open source ;)</p><h2 id=deploying-the-space>Deploying the Space</h2><p>Once you have gathered all the necessary DigitalOcean credentials, we can now create the Space! Naturally, we are going to use Terraform to do this. You could use the beautiful DigitalOcean UI to create the Space but let&rsquo;s be honest, thats no fun. If you&rsquo;re lazy and don&rsquo;t want to go through the hazzle of writing 10 lines of HCL, you could use the <a href=https://github.com/GonzalezAndrew/terraform-do-remote-state target=_blank>DigitalOcean Space Bucket Terraform Module</a>
I have already wrote! To use the module, follow the steps below.</p><ol><li>Create a new directory named <code>terraform-do-remote-state</code></li></ol><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>$ mkdir -p ~/projects/terraform-do-remote-state
</code></pre></td></tr></table></div></div><ol start=2><li>Create a <code>main.tf</code> file, import the module and fill out any attributes you want. For example:</li></ol><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-hcl data-lang=hcl><span class=k>terraform</span> {
<span class=n>  required_version</span> <span class=o>=</span><span class=n> &#34;&gt;</span><span class=o>=</span> <span class=m>0</span><span class=p>.</span><span class=m>12</span><span class=p>.</span><span class=m>6</span><span class=p>,</span> <span class=err>&lt;</span> <span class=m>0</span><span class=p>.</span><span class=m>16</span><span class=err>&#34;</span>
  <span class=k>required_providers</span> {
<span class=n>    digitalocean</span> <span class=o>=</span> {
<span class=n>      source</span>  <span class=o>=</span> <span class=s2>&#34;digitalocean/digitalocean&#34;</span>
<span class=n>      version</span> <span class=o>=</span> <span class=s2>&#34;~&gt; 2.0&#34;</span>
    }
  }
}


<span class=k>provider</span> <span class=s2>&#34;digitalocean&#34;</span> {
<span class=n>  token</span> <span class=o>=</span> <span class=s2>&#34;&lt;do_token&gt;&#34;</span>
<span class=n>  spaces_access_id</span> <span class=o>=</span> <span class=s2>&#34;&lt;your_id&gt;&#34;</span>
<span class=n>  spaces_secret_key</span> <span class=o>=</span> <span class=s2>&#34;&lt;your_key&gt;&#34;</span>
}

<span class=k>module</span> <span class=s2>&#34;bucket&#34;</span> {
<span class=n>  source</span> <span class=o>=</span><span class=n> &#34;git::github.com/GonzalezAndrew/terraform-do-remote-state.git?ref</span><span class=o>=</span><span class=k>v1</span><span class=p>.</span><span class=m>0</span><span class=err>&#34;</span>
<span class=n>  name</span>   <span class=o>=</span> <span class=s2>&#34;tf-state-nyc3&#34;</span>
<span class=n>  region</span> <span class=o>=</span> <span class=s2>&#34;nyc3&#34;</span>
}
</code></pre></td></tr></table></div></div><p>Yes, I have tried to set the DigitalOcean credentials using their appropriate environment variables but it doesnt work. So for now, I&rsquo;m using static credentials and no I will not push this to GitHub and neither should you!</p><ol start=3><li>Run <code>terraform init</code>, <code>terraform plan</code>, and <code>terraform apply</code><figure><img src=/images/posts/do_1.PNG alt=Terminal></figure></li><li>Verify the Space was created correctly checking the DigitalOcean UI.<figure><img src=/images/posts/do_2.PNG alt=UI></figure></li></ol><p>That&rsquo;s it! You have now deployed a DigitalOcean Space that you can use for storing your Terraform remote state files.</p></div><div class=tags><div class=taxosfloating_left><p>Tags</p></div><div class=termsfloating_right><p><a href=/tags/digitalocean/>digitalocean</a>
<a href=/tags/terraform/>terraform</a>
<a href=/tags/tutorial/>tutorial</a></p></div><div class=clearit></div></div></div></main><footer>© Andrew Gonzalez 2020 - 2021. Powerd by <a href=https://gohugo.io>Hugo</a></footer></body></html>